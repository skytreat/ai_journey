# IPAM System - Developer Guide

## Project Overview

This is an enterprise-grade IP Address Management (IPAM) system built with .NET 7 and C#. The system provides comprehensive IP address management with hierarchical tree structures, tag inheritance, and role-based access control.

### Key Technologies
- **Language**: C# (.NET 7)
- **Architecture**: Microservices with API Gateway pattern
- **Database**: Azure Table Storage
- **Authentication**: JWT with RBAC
- **Caching**: In-memory caching with decorator pattern
- **Monitoring**: OpenTelemetry integration
- **Testing**: Unit tests, Integration tests
- **Containerization**: Docker, Kubernetes, Azure Container Apps

### Core Features
- IP address management with CIDR notation in hierarchical tree structure
- Address space management with automatic root node creation (`::/0` and `0.0.0.0/0`)
- Advanced tag system with inheritance and implication rules
- RESTful API with comprehensive CRUD operations
- Role-based access control (SystemAdmin, AddressSpaceAdmin, AddressSpaceOperator, AddressSpaceViewer)
- Automatic parent-child relationship management for IP nodes
- Concurrent modification conflict resolution using optimistic locking

## Project Structure

### Source Code (`src/`)
- **Ipam.Gateway** - API Gateway with authentication, authorization, rate limiting
- **Ipam.Frontend** - RESTful API service with controllers and business logic
- **Ipam.DataAccess** - Data persistence layer with Azure Table Storage integration
- **Ipam.Client** - C# client library for API consumption
- **Ipam.PowershellCLI** - PowerShell command-line interface
- **Ipam.WebPortal** - Web-based user interface (ASP.NET Core + Bootstrap)

### Tests (`tests/`)
- **Ipam.DataAccess.Tests** - Unit and integration tests for data layer
- **Ipam.Frontend.Tests** - API controller and validation tests
- **Ipam.IntegrationTests** - End-to-end integration tests
- **Ipam.UnitTests** - General unit tests

### Documentation (`docs/`)
- **Requirements.md** - Detailed functional and non-functional requirements (Chinese)
- **IPAM_System_Design.md** - Comprehensive system design document
- **Instructions.md** - Development guidelines and coding standards

## Development Guidelines

### C# Coding Standards
- Follow Microsoft's official C# coding conventions
- One class per file with descriptive naming
- All files must have header comments with name, description, author, and date
- Use XML documentation comments for all classes and methods
- Include `<summary>`, `<remarks>`, `<param>`, and `<returns>` tags

### Example Header Comment Format
```csharp
/// <summary>
/// Service for managing IP tree structure and relationships
/// </summary>
/// <remarks>
/// Author: IPAM Team
/// Date: 2024-01-20
/// </remarks>
public class IpTreeService
{
    /// <summary>
    /// Creates an IP node with automatic parent detection
    /// </summary>
    /// <param name="addressSpaceId">The address space ID</param>
    /// <param name="cidr">The CIDR notation</param>
    /// <returns>The created IP node</returns>
    public async Task<IpNode> CreateIpNodeAsync(string addressSpaceId, string cidr)
    {
        // Implementation
    }
}
```

### Dependency Injection Pattern
- Use constructor injection for all dependencies
- Register services in `DataAccessServiceCollectionExtensions.cs`
- Implement interfaces for all service contracts
- Use decorator pattern for cross-cutting concerns (caching, logging)

### Repository Pattern Implementation
- Base repository with common CRUD operations
- Specific repositories for each entity type
- Unit of Work pattern for transaction management
- Caching decorators for performance optimization

## Architecture Patterns

### Microservices Architecture
```
API Gateway (Authentication, Authorization, Rate Limiting)
    ↓
Frontend API (Controllers, Validation, Business Logic)
    ↓
DataAccess Layer (Repositories, Services, Caching)
    ↓
Azure Table Storage (Persistence)
```

### Key Design Patterns Used
- **Repository Pattern** - Data access abstraction
- **Unit of Work Pattern** - Transaction management
- **Decorator Pattern** - Caching and cross-cutting concerns
- **Service Layer Pattern** - Business logic encapsulation
- **Dependency Injection** - Loose coupling and testability

### Data Model Hierarchy
```
AddressSpace
├── Tags (with inheritance and implication rules)
└── IP Nodes (hierarchical tree structure)
    ├── IPv6 Root (::/0)
    └── IPv4 Root (0.0.0.0/0)
        └── Child IP nodes with automatic parent detection
```

## API Design

### RESTful Endpoints Structure
```http
# Address Spaces
GET/POST/PUT/DELETE /api/addressspaces[/{id}]

# Tags (nested under address spaces)
GET/POST/PUT/DELETE /api/addressspaces/{addressSpaceId}/tags[/{name}]

# IP Nodes (nested under address spaces)
GET/POST/PUT/DELETE /api/addressspaces/{addressSpaceId}/ipnodes[/{id}]
GET /api/addressspaces/{addressSpaceId}/ipnodes/byPrefix?prefix={cidr}
GET /api/addressspaces/{addressSpaceId}/ipnodes/byTags?tags={key=value}
GET /api/addressspaces/{addressSpaceId}/ipnodes/{id}/children
```

### Authentication & Authorization
- JWT Bearer token authentication required for all endpoints
- Role-based authorization with hierarchical permissions
- Use `[Authorize(Roles = "SystemAdmin,AddressSpaceAdmin")]` attributes

## Configuration

### Required Environment Variables
```bash
# Azure Table Storage
AzureTableStorage="DefaultEndpointsProtocol=https;AccountName=...;AccountKey=..."

# JWT Configuration
Jwt:Issuer="IpamSystem"
Jwt:Audience="IpamUsers"
Jwt:Key="YourSecretKeyHere"

# Service URLs
FrontendServiceUrl="https://localhost:5001"
```

### DataAccess Configuration Example
```csharp
services.AddIpamDataAccess(options =>
{
    options.ConnectionString = Configuration.GetConnectionString("AzureTableStorage");
    options.EnableCaching = true;
    options.CacheDuration = TimeSpan.FromMinutes(5);
});
```

## Building and Running

### Prerequisites
- .NET 7 SDK
- Azure Storage Account or Azure Storage Emulator
- Visual Studio 2022 or VS Code

### Build Commands
```bash
# Build entire solution
dotnet build IPAM.sln

# Build specific project
dotnet build src/Ipam.Frontend/Ipam.Frontend.csproj

# Run tests
dotnet test

# Run specific service
dotnet run --project src/Ipam.Gateway
```

### Development Workflow
1. Build solution: `dotnet build`
2. Run tests: `dotnet test`
3. Start API Gateway: `dotnet run --project src/Ipam.Gateway`
4. Start Frontend API: `dotnet run --project src/Ipam.Frontend`

## Testing Strategy

### Test Coverage Requirements
- Minimum 90% code coverage for all business logic
- Unit tests for all service classes and repositories
- Integration tests for API endpoints
- Performance tests for scalability validation

### Test Categories
- **Unit Tests** - Individual component testing
- **Integration Tests** - Service interaction testing
- **Functional Tests** - End-to-end business scenario testing
- **Performance Tests** - Load and stress testing

## Advanced Features

### Tag Inheritance System
- **Inheritable Tags** - Automatically inherited from parent to child IP nodes
- **Tag Implications** - Automatic tag addition based on implication rules
- **Conflict Resolution** - Validation to prevent tag conflicts in parent-child relationships
- **Tag Propagation** - When parent nodes are deleted, inheritable tags propagate to children

### IP Tree Management
- **Automatic Parent Detection** - CIDR-based parent finding algorithm
- **Hierarchical Structure** - IPv6 `::/0` root with IPv4 `0.0.0.0/0` as child
- **Concurrent Modification** - Optimistic locking with ETag for conflict resolution
- **Same CIDR Validation** - Child nodes with same CIDR must have additional inheritable tags

### Performance Optimizations
- **Memory Caching** - Decorator pattern for repository caching
- **Response Caching** - HTTP response caching for read operations
- **Lazy Loading** - Efficient data loading strategies
- **Batch Operations** - Optimized bulk operations for large datasets

## Troubleshooting

### Common Build Issues
- **Missing Dependencies** - Run `dotnet restore` before building
- **Target Framework** - Ensure .NET 7 SDK is installed
- **Azure Storage** - Verify connection string is correct

### Performance Considerations
- Enable caching for read-heavy workloads
- Use appropriate partition keys for Azure Table Storage
- Monitor memory usage with large IP address datasets
- Implement pagination for large result sets

## Contributing

### Code Review Checklist
- [ ] XML documentation comments added
- [ ] Unit tests written and passing
- [ ] Follows C# coding standards
- [ ] Dependency injection properly implemented
- [ ] Error handling and logging included
- [ ] Performance impact considered

### Git Workflow
1. Create feature branch from main
2. Implement changes with tests
3. Ensure all tests pass
4. Submit pull request with description
5. Code review and merge

## Deployment

### Container Support
- Docker images for all services
- Kubernetes deployment manifests
- Azure Container Apps configuration
- CI/CD pipeline integration

### Monitoring and Observability
- OpenTelemetry integration for distributed tracing
- Azure Application Insights integration
- Custom metrics and health checks
- Structured logging with correlation IDs

---

*This guide is maintained by the IPAM development team. For questions or updates, please refer to the project documentation or contact the development team.*